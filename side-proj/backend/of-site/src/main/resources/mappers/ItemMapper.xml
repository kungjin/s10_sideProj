<!-- src/main/resources/mappers/ItemMapper.xml -->
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.of.mapper.ItemMapper">

  <insert id="upsertItem" parameterType="com.of.domain.Item">
  INSERT INTO item_current (
    source, notice_no, item_no, title, addr_lot, addr_road, usage_name,
    sale_type, min_bid_price, appraisal_amt,
    bid_start_at, bid_end_at, status_name,
    failed_count, view_count, content_hash, updated_at, missing_count
  )
  VALUES (
    #{source}, #{noticeNo}, #{itemNo}, #{title}, #{addrLot}, #{addrRoad}, #{usageName},
    #{saleType}, #{minBidPrice}, #{appraisalAmt},
    #{bidStartAt}, #{bidEndAt}, #{statusName},
    #{failedCount}, #{viewCount}, #{contentHash}, NOW(6), 0
  )
  ON DUPLICATE KEY UPDATE
    title         = VALUES(title),
    addr_lot      = VALUES(addr_lot),
    addr_road     = VALUES(addr_road),
    usage_name    = VALUES(usage_name),
    sale_type     = VALUES(sale_type),
    min_bid_price = VALUES(min_bid_price),
    appraisal_amt = VALUES(appraisal_amt),
    bid_start_at  = VALUES(bid_start_at),
    bid_end_at    = VALUES(bid_end_at),
    status_name   = VALUES(status_name),
    failed_count  = VALUES(failed_count),
    view_count    = VALUES(view_count),
    content_hash  = IF(VALUES(content_hash) != content_hash, VALUES(content_hash), content_hash),
    updated_at    = IF(VALUES(content_hash) != content_hash, NOW(6), updated_at),
    missing_count = 0
</insert>

<!-- ðŸ”¹ ì¡°íšŒìš©: ë§ˆê° ìž„ë°• ìˆœìœ¼ë¡œ ìƒìœ„ Nê°œ ê°€ì ¸ì˜¤ê¸° -->
  <select id="findRecent" resultType="com.of.dto.OnbidItemDto">
  SELECT
    notice_no    AS noticeNo,
    item_no      AS itemNo,
    title        AS title,
    addr_road    AS addrRoad,
    usage_name   AS usageName,
    sale_type    AS saleType,
    min_bid_price AS minBidPrice,
    appraisal_amt AS appraisalAmt,
    DATE_FORMAT(bid_start_at, '%Y%m%d%H%i%S') AS bidStartAt,
    DATE_FORMAT(bid_end_at,   '%Y%m%d%H%i%S') AS bidEndAt,
    status_name  AS statusName,
    failed_count AS failedCount,
    view_count   AS viewCount
  FROM item_current
  WHERE bid_end_at IS NOT NULL
  ORDER BY bid_end_at ASC
  LIMIT #{limit}
</select>
</mapper>
